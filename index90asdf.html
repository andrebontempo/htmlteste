<script>
  const chatContainer = document.getElementById("chat-container")
  const chatBody = document.getElementById("chat-body")
  const userInput = document.getElementById("user-input")

  // üëá Dados fixos do usu√°rio
  const userName = "Jo√£o da Silva"
  const userEmail = "joao.silva@embrapa.br"
  const userMatricula = "123456"

  function toggleChat() {
    chatContainer.style.display =
      chatContainer.style.display === "flex" ? "none" : "flex"
    chatContainer.style.flexDirection = "column"
    if (chatContainer.style.display === "flex") {
      setTimeout(() => userInput.focus(), 200)
    }
  }

  function appendMessage(sender, text) {
    const msg = document.createElement("div")
    msg.className = `message ${sender}`

    if (sender === "bot") {
      const avatar = document.createElement("img")
      avatar.className = "avatar"
      avatar.src =
        "https://transfer.sede.embrapa.br/transfer/cst/chatbot/flora2025/Flora_Widget_001.png"
      avatar.alt = "Flora"

      const textDiv = document.createElement("div")
      textDiv.className = "text"
      textDiv.innerHTML = text

      msg.appendChild(avatar)
      msg.appendChild(textDiv)
    } else {
      msg.textContent = text
    }

    chatBody.appendChild(msg)
    chatBody.scrollTop = chatBody.scrollHeight
  }

  function showTypingIndicator() {
    const indicator = document.createElement("div")
    indicator.className = "typing-indicator"
    indicator.id = "typing-indicator"
    indicator.innerHTML = `
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    `
    chatBody.appendChild(indicator)
    chatBody.scrollTop = chatBody.scrollHeight
  }

  function removeTypingIndicator() {
    const indicator = document.getElementById("typing-indicator")
    if (indicator) {
      chatBody.removeChild(indicator)
    }
  }

  async function sendMessage() {
    const message = userInput.value.trim()
    if (!message) return

    appendMessage("user", message)
    userInput.value = ""

    showTypingIndicator()

    try {
      const response = await fetch(
        "https://flora-n8n.a.agro.rocks/webhook/florachat",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            nome: userName,
            email: userEmail,
            matricula: userMatricula,
          }),
        }
      )

      const data = await response.json()
      removeTypingIndicator()
      appendMessage("bot", data.reply || "Desculpe, n√£o entendi.")
    } catch (error) {
      console.error("Erro na comunica√ß√£o com o webhook:", error)
      removeTypingIndicator()
      appendMessage("bot", "Erro ao se comunicar com o servidor.")
    }
  }

  userInput.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault()
      sendMessage()
    }
  })
</script>
